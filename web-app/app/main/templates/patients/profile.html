{% extends "base_site.html" %}

{% block title %} Profile {% endblock title %}

{% block stylesheets %}
{{ super() }}
{% endblock stylesheets %}

{% block content %}

{% include "site_template/navigation.html" %}

<!-- Header -->
{% include "site_template/top-stats.html" %}

<!-- Modal DELETE PATIENT-->
<div class="modal fade" id="deletePatientModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">{{ _("Удалить пациента?") }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                </button>
            </div>

            <div class="modal-body">
                {{ _("Вы уверены, что хотите удалить пациента") }} <bold> {{patient.first_name}} </bold>?
            </div>
            <div class="modal-footer">
                <form action="/delete_patient" method="POST">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="delete" value='{{ patient.id }}'>
                    <button type="submit" class="btn btn-primary">{{ _("Да") }}</button>
                </form>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Нет") }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal ADD STATE-->
<div class="modal fade" id="addPatientStateModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">{{ _("Добавить статус") }}</h5>
                <button id="openAddStatusButton" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                </button>
            </div>

            <form id="addStateForm">
                <div class="modal-body" id="addStateModalBody">
                        <input type="hidden" name="id" id="addStatePatientID" value='{{ patient.id }}'>
                        <div class="form-group">
                            <label for="name-input" class="form-control-label">{{ _("Статус") }}*</label>
                            {{ form.state(class="form-control", id="addStateStateValue") }}
                        </div>
                        <div class="form-group">
                            <label for="name-input" class="form-control-label">{{ _("Комментарий") }}</label>
                            {{ form.stateComment(class="form-control", id="addStateComment", type="text") }}
                        </div>
                        <div class="form-group">
                            <label for="name-input" class="form-control-label">{{ _("Дата выявления") }}*</label>
                            {{ form.stateDetectionDate(class="form-control datepicker", id="addStateDate", type="date") }}
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Отмена") }}</button>
                    <button type="button" id="addStateButton" class="btn btn-primary">{{ _("Добавить") }}</button>
                    <input type="submit" id="hiddenAddState" class="btn btn-primary" style="display:none;"></input>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal DELETE PatientState -->
<div class="modal fade" id="deletePatientStateModal" tabindex="-1" role="dialog" aria-labelledby="deletePatientStateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deletePatientStateModalLabel">{{ _("Удаление статуса") }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h2>{{ _("Вы уверены что хотите удалить статус?") }}</h2>
          <p>{{ _("Статус:") }} <span id="deletePatientStateState"></span></p>
          <p>{{ _("Комментарий:") }} <span id="deletePatientStateComment"></span></p>
          <p>{{ _("Дата выявление:") }} <span id="deletePatientStateDate"></span></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Отмена") }}</button>
          <!-- <form action="/delete_state" method="POST"> -->
            <!-- {{ form.hidden_tag() }} -->
            <input type="hidden" name="id" id="deletePatientStateID" value=''>
            <input type="hidden" name="patientID" id="deleteStatePatientID" value='{{ patient.id }}'>
            <button type="button" id="deleteStateButton" class="btn btn-danger">{{ _("Удалить") }}</button>
        <!-- </form> -->
        </div>
      </div>
    </div>
  </div>

<!-- Modal UPDATE STATE-->
<div class="modal fade" id="updatePatientStateModal" tabindex="-1" role="dialog" aria-labelledby="updatePatientStateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updatePatientStateModalLabel">{{ _("Изменить статус") }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true"></span>
                </button>
            </div>

            <form id="editStateForm">
                <div class="modal-body" id="editStateModalBody">
                        <input type="hidden" name="patientID" id="updatePatientPatientID" value='{{ patient.id }}'>
                        <input type="hidden" name="id" id="updatePatientStateID" value=''>
                        <div class="form-group">
                            <label for="name-input" class="form-control-label">{{ _("Статус") }}</label>
                            {{ form.state(class="form-control", id="updatePatientStateState", disabled=True) }}
                        </div>
                        <div class="form-group">
                            <label for="name-input" class="form-control-label">{{ _("Комментарий") }}</label>
                            <input class="form-control" id="updatePatientStateComment" name="comment" type="text" value="">
                        </div>
                        <div class="form-group">
                            <label for="name-input" class="form-control-label">{{ _("Дата выявления") }}</label>
                            <input class="form-control datepicker" id="updatePatientStateDate" name="detection_date" type="date" value="">
                        </div>
                        </div>
                <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">{{ _("Отмена") }}</button>
                        <button type="button" id="updateStateButton" class="btn btn-primary">{{ _("Сохранить") }}</button>
                        <input type="submit" id="hiddenEditState" class="btn btn-primary" style="display:none;"></input>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--7">
    <form method="POST"> 
        {{ form.hidden_tag() }}        
        <div class="row">
            <div class="col-xl-3 order-xl-2 mb-5 mb-xl-0">
                {% if patient.home_address.lat %}
                <div class="card shadow">
                   <div id="map" style="width:100%; height:215px"></div>
               </div>
               <div class="card card-profile shadow mt-3">
                {% else %}
                <div class="card card-profile shadow mt-0">
                 {% endif %}
                 <div class="card-body pt-0">
                    <div class="row mt-3">
                        <div class="col">
                            <div class="form-group">
                                <label for="name-input" class="form-control-label">{{ _("Время Добавления") }}</label>
                                <div>{{ patient.created_date.strftime("%d-%m-%Y %H:%M") }}</div>
                            </div>
                        </div>
                        {% if patient.created_by %}
                        <div class="col">
                            <div class="form-group">
                                <label for="name-input" class="form-control-label">{{ _("Логин Специалиста") }}</label>
                                <div>
                                {% if current_user.user_role.can_access_users %}
                                    <a href="/user_profile?id={{ patient.created_by_id }}">{{ patient.created_by.username }}</a>
                                {% else %}
                                    {{ patient.created_by.username }}
                                {% endif %}
                                </div>
                            </div>             
                        </div>
                        {% endif %}
                    </div>
                    {% if patient.created_by %}
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="name-input" class="form-control-label">{{ _("Регион Специалиста") }}</label>
                                <div>{{ patient.created_by.region }}</div>
                            </div>             
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="name-input" class="form-control-label">{{ _("Организация") }}</label>
                                <div>{{ patient.created_by.organization }}</div>
                            </div>             
                        </div>                                                
                    </div>
                    {% if current_user.user_role.can_access_user_info %}
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="name-input" class="form-control-label">{{ _("Телефон") }}</label>
                                <div>{{ patient.created_by.telephone }}</div>
                            </div>             
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="name-input" class="form-control-label">{{ _("E-Mail") }}</label>
                                <div>{{ patient.created_by.email }}</div>
                            </div>             
                        </div>                                                
                    </div>
                    {% endif %}
                    {% endif %}
                    <div class="row">
                        <div class="col">
                        <hr class="my-3" />
                        <div class="text-center">
                            <a href="/patient_edit_history?id={{ patient.id }}" class="btn btn-primary btn-full-width">{{ _("История Изменений") }}</a>
                        </div>
                    </div>
                    </div>  
                </div>
            </div>
            <div class="card card-profile shadow mt-3">
                <div class="card-body pt-0 pt-md-4">
                        <h3>
                            {{ _("Возраст") }} {{ age }}<span class="font-weight-light"></span>
                        </h3>
                        <div class="row" id="patientBadgesRow"></div>
                        <hr class="my-4" />
                    {% if patient.in_hospital %}    
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="name-input" class="form-control-label">{{ _("Регион Госпитализации") }}</label>
                                <div>{{ patient.hospital.region }}</div>
                            </div>             
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="name-input" class="form-control-label">{{ _("Место Госпитализации") }}</label>
                                <div><a href="/hospital_profile?id={{ patient.hospital.id }}">{{ patient.hospital }}</a></div>
                            </div>             
                        </div>                                                
                    </div>                                        
                    <hr class="my-4" />               
                    {% endif %}
            <div class="row">
                <div class="col">
                <div class="text-center">
                    <a href="/contacted_persons?id={{ patient.id }}" class="btn btn-primary btn-full-width">{{ _("Контактные Лица") }}</a>
                 {% if patient.travel_type.value == c.flight_type[0] %}
                 <a href="/flight_profile?id={{ travel.flight_code.id }}" class="btn btn-primary btn-full-width mt-3">{{ _("Прилетевшие Вместе") }}</a>
                 {% elif patient.travel_type.value == c.train_type[0] %}
                 <a href="/train_profile?id={{ travel.train.id }}" class="btn btn-primary btn-full-width mt-3">{{ _("Прибывшие Вместе") }}</a>
                 {% endif %}
             </div>
         </div>
         </div>            
             <hr class="my-4" />               
         <div class="row mt-3">
            <div class="col" style="text-align:center;">
                <input class="btn btn-primary" id="submit" name="submit" type="submit" value={{ _("Сохранить") }}>
            </div>
            <div class="col" style="text-align:center;">
                <input class="btn btn-danger" data-toggle="modal" type="button" data-target="#deletePatientModal" value={{ _("Удалить") }}>                
            </div>
        </div>
        <!-- </div> -->
    </div>
</div>

</div>
<div class="col-xl-9 order-xl-1">
    <div class="card bg-secondary shadow">
    <div class="card-header bg-white">
        <div class="row align-items-center">
            <div class="col">
                <h3 class="mb-0">История статусов</h3>
            </div>
            <div class="col" style="text-align: end;">
                <button data-toggle="modal" type="button" data-target="#addPatientStateModal"  class="btn btn-primary btn-sm">Добавить статус</button>
            </div>            
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <div>
                <table class="table align-items-center">
                    <thead class="thead-light">
                        <tr>
                            <th scope="col">Статус</th>
                            <th scope="col">Комментарий</th>
                            <th scope="col">Дата выявления</th>
                            <th scope="col"></th>
                        </tr>
                    </thead>
                    <tbody class="list" id="stateHistoryTable">
  
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-3">
      <div class="col">
        <div class="card shadow">
          <div class="card-header bg-transparent">
            <h3 class="mb-0">{{ _("Тип Въезда") }}</h3>
          </div>    
          <div class="card-body">
            {% with form=form %}
            {% include "patients/modules/travel_form.html" %}
            {% endwith %}
        </div>
        </div>
      </div>
    </div>            
    <div class="card bg-secondary shadow mt-3">
        <div class="card-header bg-white">
            <div class="row align-items-center">
                <div class="col">
                    <h3 class="mb-0">{{ patient }}</h3>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="col">
              <div class="col">
                {% with form=form %}
                {% include "patients/modules/patient_form_left.html" %}
                {% endwith %} 
            </div>
            <div class="col mt-3">
                {% with form=form %}
                {% include "patients/modules/patient_form_right.html" %}
                {% endwith %}                         
            </div>
        </div>


        
    </div>
</div>
</div>
</div>
</form>



{% include "site_template/footer.html" %}

</div>    

{% endblock content %}

{% block javascripts %}
{{ super()}}
{% include "js/hospital_selection_form.html" %}

<script type="text/javascript">
    {% with form=form, c=c %}
    {% include "js/travel_form.html" %}
    {% endwith %}

    setup_form()
    let hospitalised = "{{ patient.in_hospital }}" == "True";
    let is_found = "{{ patient.is_found }}" == "True";
    
    // Disable travel type select for profile page
    // $("#travel_type").prop('disabled', true);
    $("#travel_type").on("change", function(){
    update_travel_form();
    renderStateHistoryTable()
});

    {% if patient.home_address.lat %}
    ymaps.ready(init);

    function init() {
        var myMap = new ymaps.Map("map", {
            center: [{{ patient.home_address.lat }}, {{ patient.home_address.lng }}],
            zoom: 12,
            controls: ['zoomControl']
        }, {
            searchControlProvider: 'yandex#search'
        })

        myMap.geoObjects
        .add(new ymaps.Placemark([{{ patient.home_address.lat }}, {{ patient.home_address.lng }} ], {
            balloonContent: '{{ patient }}</a>'
        }, {
            preset: 'islands#icon',
            iconColor: 'red'
        }))
    }
    {% endif %}

    // function found_changed(value) {
    //     disable = true;
    //     if (value == 1 || value == true) {
    //         disable = false;
    //     }

    //     document.getElementById('in_hospital_checkbox').disabled = disable;

    //     document.getElementById('is_home').disabled = disable;
    //     document.getElementById('is_transit').disabled = disable;
        
    //     disable_hospital_choice(hospitalised);
    // }

    function setup_form() {
        update_travel_form();
        {% if patient.travel_type.value == c.flight_type[0] %}
            $("#flight_arrival_date").val('{{ travel.flight_code.date }}')
            $("#flight_arrival_date").change()
            $("#flight_code_id").val('{{ travel.flight_code.id }}')
            {% if travel.seat %}
                $("#flight_seat").val('{{ travel.seat }}')
            {% endif %}
        {% elif patient.travel_type.value == c.train_type[0] %}
            $("#train_departure_date").val('{{ travel.train.departure_date }}')
            $("#train_departure_date").change()

            $("#train_arrival_date").val('{{ travel.train.arrival_date }}')
            $("#train_arrival_date").change()

            $("#train_id").val('{{ travel.train.id }}')
            {% if travel.wagon %}
                $("#train_wagon").val('{{ travel.wagon }}')
            {% endif %}             
            {% if travel.seat %}
                $("#train_seat").val('{{ travel.seat }}')
            {% endif %}            
        {% else %}
            $("#arrival_date").val('{{ travel.date }}')
            {% if patient.travel_type.value == c.blockpost_type[0] %}
                 $("#blockpost_region_id").val('{{ travel.region_id }}')
            {% endif %}
            
            var border_form_id = null

            switch('{{ patient.travel_type.value }}') {
              case '{{c.by_auto_type[0]}}':
              border_form_id = "#auto_border_id"
              break;
              case '{{c.by_foot_type[0]}}':
              border_form_id = "#foot_border_id"
              break;
              case '{{c.by_sea_type[0]}}':
              border_form_id = "#sea_border_id"
              break;
          }

            if (border_form_id) $(border_form_id).val({{ travel.border_control_id }})
        {% endif %}
    }

    function fillDeletePatientState(stateID, stateName, stateComment, stateDetectionDate, stateAttrs) {
        document.getElementById("deletePatientStateState").innerText = stateName;
        document.getElementById("deletePatientStateComment").innerText = stateComment;
        document.getElementById("deletePatientStateDate").innerText = stateDetectionDate;
        document.getElementById("deletePatientStateID").value = stateID;
    }

    function fillUpdatePatientState(stateID, stateName, stateComment, stateDetectionDate, stateAttrs) {
        let stateValue = null;
        for (let i = 0; i < document.getElementById("updatePatientStateState").options.length; i++) {
            if (document.getElementById("updatePatientStateState").options[i].text == stateName) {
                stateValue = document.getElementById("updatePatientStateState").options[i].value;
                break;
            }
        }
		document.getElementById("updatePatientStateState").value = stateValue;
        document.getElementById("updatePatientStateComment").value = stateComment;
        document.getElementById("updatePatientStateDate").value = stateDetectionDate.slice(0,10);
        document.getElementById("updatePatientStateID").value = stateID;

        $("#updatePatientStateState").trigger("change")
        stateAttrs = JSON.parse(unescape(stateAttrs))

        if (stateValue === '{{ c.state_hosp[0] }}') {
            $("#hospital_region_id").val(stateAttrs["hospital_region_id"])            
            $("#hospital_type_id").val(stateAttrs["hospital_type_id"])
            update_hospitals_list(false)

            $("#hospital_id").val(stateAttrs["hospital_id"])
        } else if (stateValue === '{{ c.state_is_home[0] }}') {
            $("#is_home_end").val(stateAttrs["is_home_end"])
            $("#is_home_end").change()
        } else if (stateValue === '{{ c.state_infec[0] }}') {
            $("#state_infec_type").val(stateAttrs["state_infec_type"])
            $("#state_infec_type").change()

            $("#state_infec_illness_symptoms").val(stateAttrs["state_infec_illness_symptoms"])
            $("#state_infec_illness_symptoms").change()

            $("#state_infec_illness_severity").val(stateAttrs["state_infec_illness_severity"])
            $("#state_infec_illness_severity").change()
        } else if (stateValue === '{{ c.state_dead[0] }}') {
            $("#state_dead_reason").val(stateAttrs["state_dead_reason"])
            $("#state_dead_reason").change()
            console.log($("#state_dead_reason").val())
        }
    }

    function get_patient_badges() {
        $.ajax({
            url: "/get_patient_badges",
            type: "post",
            contentType: "application/json",
            data: JSON.stringify({"patient_id": '{{ patient.id }}' }),
            success: function (response) {
                $("#patientBadgesRow").empty()
                
                if(response["badges"]["is_found"]) {
                    var badge = $("<span style='margin-top: 0.5rem; margin-left: 0.5rem;' class='badge badge-primary'>{{ _("Найден") }}</span>")
                    $("#patientBadgesRow").append(badge)
                }
                if(response["badges"]["is_infected"]) {
                    var badge = $("<span style='margin-top: 0.5rem; margin-left: 0.5rem;' class='badge badge-danger'>{{ _("Инфицирован") }}</span>")
                    $("#patientBadgesRow").append(badge)
                }                
                if(response["badges"]["in_hospital"]) {
                    var badge = $("<span style='margin-top: 0.5rem; margin-left: 0.5rem;' class='badge badge-success'>{{ _("Госпитализирован") }}</span>")
                    $("#patientBadgesRow").append(badge)
                }
                if(response["badges"]["is_home"]) {
                    var badge = $("<span style='margin-top: 0.5rem; margin-left: 0.5rem;' class='badge badge-info'>{{ _("Домашний Карантин") }}</span>")
                    $("#patientBadgesRow").append(badge)
                }
                if(response["badges"]["is_dead"]) {
                    var badge = $("<span style='margin-top: 0.5rem; margin-left: 0.5rem;' class='badge badge-warning'>{{ _("Умер") }}</span>")
                    $("#patientBadgesRow").append(badge)
                }                                
            },
        })        
    }

    function renderStateHistoryTable(response) {
        let stateHistoryTable = document.getElementById("stateHistoryTable")
        let innerHTML = ""
        for (let i = 0; i < response.states.length; i++) {
            var attrs = escape(JSON.stringify(response.states[i].attrs))
            innerHTML += `
            <tr>
                <td>${response.states[i].name} </td>
                <td>${response.states[i].formatted_comment}</td>
                <td>${response.states[i].formatted_detection_date}</td>
                <td class="text-right">
                    <div class="dropdown">
                        <a class="btn btn-sm btn-icon-only text-light" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right dropdown-menu-arrow">
                            <a onclick="fillUpdatePatientState(${ response.states[i].id }, '${ response.states[i].name }', '${ response.states[i].formatted_comment }', '${ response.states[i].detection_date }',
                                '${attrs}')" class="dropdown-item" href="#" data-toggle="modal" data-target="#updatePatientStateModal">Изменить</a>
                            <a onclick="fillDeletePatientState(${ response.states[i].id }, '${ response.states[i].name }', '${ response.states[i].formatted_comment }', '${ response.states[i].formatted_detection_date }',
                                '${response.states[i].attrs}')" 
                                class="dropdown-item" href="#" data-toggle="modal" data-target="#deletePatientStateModal">Удалить</a>
                        </div>
                    </div>
                </td>
            </tr>`
        }
        stateHistoryTable.innerHTML = innerHTML;
        get_patient_badges()
    }

    function handle_state_add_update(stateData) {
        switch(stateData["value"]) {
            case '{{ c.state_hosp[0] }}':
                stateData["hospital_id"] = $("#hospital_id").val()
                break;
            case '{{ c.state_is_home[0] }}':
                stateData["is_home_end"] = $("#is_home_end").val()
                break;
            case '{{ c.state_infec[0] }}':
                stateData["state_infec_type"] = $("#state_infec_type").val()
                stateData["state_infec_illness_symptoms"] = $("#state_infec_illness_symptoms").val()
                stateData["state_infec_illness_severity"] = $("#state_infec_illness_severity").val()
                break;
            case '{{ c.state_dead[0] }}':
                stateData["state_dead_reason"] = $("#state_dead_reason").val()
                console.log($("#state_dead_reason").val())
                break;
            default:
                break;
        }
    }

    function handle_csrf(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)) {
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token() }}")
        }
    }

    var updateStateAjaxLock = false;
    
    $("#updateStateButton").on("click", () => {
        let updateStateData = {
            'value':document.getElementById("updatePatientStateState").value,
            'comment':document.getElementById("updatePatientStateComment").value,
            'patient_id':document.getElementById("updatePatientPatientID").value,
            'detection_date':document.getElementById("updatePatientStateDate").value,
            'patient_state_id':document.getElementById("updatePatientStateID").value
        }
        if ($("#editStateForm")[0].checkValidity() === false) {
            $("#hiddenEditState")[0].click();
        } else {
            handle_state_add_update(updateStateData)

            if (updateStateAjaxLock === false) {
                $.ajax({
                    url: "/update_state",
                    type: "post",
                    contentType: "application/json",
                    data: JSON.stringify(updateStateData),
                    success: function (response) {
                        renderStateHistoryTable(response);
                        $('#updatePatientStateModal').modal('hide');
                        $.notify({
                            icon: 'fa fa-thumbs-up',
                            message: 'Успешно изменено'
                        },{
                            type: 'info',
                        });
                    },
                    beforeSend:function(xhr, settings) {
                        handle_csrf(xhr, settings)
                        addStateAjaxLock = true;
                    },
                    complete: function(){
                        addStateAjaxLock = false;
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                       console.log(textStatus, errorThrown, jqXHR);
                       text = 'Неизвестная ошибка';
                       if (jqXHR.status == 403)
                           text = 'Невалидные данные';
                       if (jqXHR.status == 405)
                           text = 'Пациент не найден';
                       if (jqXHR.status == 406)
                           text = 'Статус не найден';
                       if (jqXHR.status == 300)
                           text = 'Невозможно изменить, неправильная последовательность.';
            
                       $.notify({
                            icon: 'fa fa-times',
                            message: text
                        },{
                            type: 'danger',
                        });
                    }
                })
            }
        }
    });

    var deleteStateAjaxLock = false;

    $("#deleteStateButton").on("click", () => {
        let deleteStateData = {
            'patient_state_id':document.getElementById("deletePatientStateID").value,
            'patient_id':document.getElementById("deleteStatePatientID").value
        }
        if (deleteStateAjaxLock === false) {
            $.ajax({
                url: "/delete_state",
                type: "post",
                contentType: "application/json",
                data: JSON.stringify(deleteStateData),
                success: function (response) {
                    console.log(response);
                    renderStateHistoryTable(response);
                    $('#deletePatientStateModal').modal('hide');
                    $.notify({
                        icon: 'fa fa-thumbs-up',
                        message: 'Успешно удалено'
                    },{
                        type: 'info',
                    });
                },
                beforeSend:function(xhr, settings) {
                    handle_csrf(xhr, settings)
                    addStateAjaxLock = true;
                },
                complete: function(){
                    addStateAjaxLock = false;
                },            
                error: function(jqXHR, textStatus, errorThrown) {
                   console.log(textStatus, errorThrown, jqXHR);
                   text = 'Неизвестная ошибка';
                   if (jqXHR.status == 403)
                       text = 'Невалидные данные';
                   if (jqXHR.status == 405)
                       text = 'Пациент не найден';
                   if (jqXHR.status == 300)
                       text = 'Невозможно удалить, неправильная последовательность.';
        
                   $.notify({
                        icon: 'fa fa-times',
                        message: text
                    },{
                        type: 'danger',
                    });
                }
            })
        }
    });

    var addStateAjaxLock = false;

    $("#addStateButton").on("click", () => {
        const addStateData = {
            'value': document.getElementById("addStateStateValue").value,
            'comment': document.getElementById("addStateComment").value,
            'detection_date': document.getElementById("addStateDate").value,
            'patient_id': document.getElementById("addStatePatientID").value
        };

        if ($("#addStateForm")[0].checkValidity() === false) {
            $("#hiddenAddState")[0].click();
        } else {
            if (addStateAjaxLock === false) {
                handle_state_add_update(addStateData)

                $.ajax({
                    url: "/add_state",
                    type: "post",
                    contentType: "application/json",
                    data: JSON.stringify(addStateData),
                    success: function (response) {
                        renderStateHistoryTable(response);
                        $('#addPatientStateModal').modal('hide');
                        $.notify({
                            icon: 'fa fa-thumbs-up',
                            message: 'Успешно добавлено'
                        },{
                            type: 'info',
                        });
                    },
                    beforeSend:function(xhr, settings) {
                        handle_csrf(xhr, settings)
                        addStateAjaxLock = true;
                    },
                    complete: function(){
                        addStateAjaxLock = false;
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                       console.log(textStatus, errorThrown, jqXHR);
                       text = 'Неизвестная ошибка';
                       if (jqXHR.status == 403)
                           text = 'Невалидные данные';
                       if (jqXHR.status == 405)
                           text = 'Пациент не найден';
                       if (jqXHR.status == 300)
                           text = 'Невозможно добавить, неправильная последовательность.';
            
                       $.notify({
                            icon: 'fa fa-times',
                            message: text
                        },{
                            type: 'danger',
                        });
                    }
                });
            }
        }
    });

    function weeksBetween(d1, d2) {
        var diff = (d2 - d1) / (7 * 24 * 60 * 60 * 1000);
        if (diff < 0) return 0

        return Math.round(diff);
    }

    var hospitalForm = `<div class="form-group">
                        <label for="job-input" class="form-control-label">{{ _("Регион Госпитализации") }}</label>
                    {{ form.hospital_region_id(class="form-control", onchange="update_hospitals_list()") }}
                    </div>
                    <div class="form-group">
                        <label for="job-input" class="form-control-label">{{ _("Тип Больницы") }}</label>
                        {{ form.hospital_type_id(class="form-control", onchange="update_hospitals_list()") }}
                    </div>
                    <div class="form-group">
                        <label for="job-input" class="form-control-label">
                            {% if patient.hospital_id %} 
                            <a href="/hospital_profile?id={{ patient.hospital_id }}">{{ _("Место Госпитализации") }}</a>
                            {% else %}
                            {{ _("Место Госпитализации") }}
                            {% endif %}
                        </label>
                        <meta name="csrf-token" content="{{ csrf_token() }}">
                        {{ form.hospital_id(class="form-control") }}
                    </div>`

    function clearStateForm(modalBodyID, modalFormLen) {
        var stateModalBody = document.getElementById(modalBodyID)
        if (stateModalBody.children.length !== modalFormLen) {
            while (stateModalBody.children.length > modalFormLen) {
                stateModalBody.removeChild(stateModalBody.lastChild);
            }
        }
    }

    function handleHospitalizedStateForm(modalBodyID, stateSelectID, updateHospitalsList=true) {
        if ($("#" + stateSelectID).val() === "{{ c.state_hosp[0] }}") {
            document.getElementById(modalBodyID).insertAdjacentHTML('beforeend', hospitalForm)
            if (updateHospitalsList) update_hospitals_list()
        }
    }

    var isHomeForm = `<div class="form-group">
                        <div class="row">
                        <div class="col">
                        <label for="job-input" class="form-control-label">{{ _("Дата Конца Дом. Карантина") }}</label>
                    {{ form.is_home_end(class="form-control", type="date") }}
                        </div>
                        <div class="col-md-auto">
                            <br><br>
                            <h4 id="is_home_end_weeks" style="color: green;"></h4>
                        </div>
                    </div>`

    function handleIsHomeStateForm(modalBodyID, stateSelectID, weekDiff = 0) {
        if ($("#" + stateSelectID).val() === "{{ c.state_is_home[0] }}") {
            document.getElementById(modalBodyID).insertAdjacentHTML('beforeend', isHomeForm)

            if (weekDiff != 0) {
                $("#is_home_end").val(new Date(new Date().getTime() + weekDiff * (7 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0])
            }

            $("#is_home_end").change(function() {
                $("#is_home_end_weeks").text(weeksBetween(new Date(), new Date($("#is_home_end").val())) + " " + '{{_("недели") }}')
            })
            $("#is_home_end").trigger("change")
        }
    }

    var infectedForm = `<div class="form-group">
                        <div class="row">
                        <div class="col">
                        <label for="job-input" class="form-control-label">{{ _("Тип Инфицирования") }}</label>
                            {{ form.state_infec_type(class="form-control") }}
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                        <div class="col">
                        <label for="job-input" class="form-control-label">{{ _("Симптомы") }}</label>
                            {{ form.state_infec_illness_symptoms(class="form-control") }}
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="row">
                        <div class="col">
                        <label for="job-input" class="form-control-label">{{ _("Тяжесть Течения Болезни") }}</label>
                            {{ form.state_infec_illness_severity(class="form-control") }}
                        </div>
                    </div>`

    function handleInfectedStateForm(modalBodyID, stateSelectID) {
        if ($("#" + stateSelectID).val() === "{{ c.state_infec[0] }}") {
            document.getElementById(modalBodyID).insertAdjacentHTML('beforeend', infectedForm)

            $("#state_infec_illness_symptoms").change(function() {
                if ($("#state_infec_illness_symptoms").val() === "{{ c.with_symptoms[0] }}") {
                    $("#state_infec_illness_severity").val($("#state_infec_illness_severity option:first").val());
                    $( "#state_infec_illness_severity" ).prop( "disabled", false );
                } else {
                    $( "#state_infec_illness_severity" ).prop( "disabled", true );
                }
            })

            $("#state_infec_illness_symptoms").trigger('change')
        }
    }

    var deadForm = `<div class="form-group">
                        <div class="row">
                        <div class="col">
                        <label for="job-input" class="form-control-label">{{ _("Причина Смерти") }}</label>
                            {{ form.state_dead_reason(class="form-control") }}
                        </div>
                    </div>`

    function handleDeadStateForm(modalBodyID, stateSelectID) {
        if ($("#" + stateSelectID).val() === "{{ c.state_dead[0] }}") {
            document.getElementById(modalBodyID).insertAdjacentHTML('beforeend', deadForm)
        }
    }

    $("#addStateStateValue").change(function() {
        clearStateForm("addStateModalBody", 4)
        handleHospitalizedStateForm("addStateModalBody", "addStateStateValue");
        handleIsHomeStateForm("addStateModalBody", "addStateStateValue", 2);
        handleInfectedStateForm("addStateModalBody", "addStateStateValue");
        handleDeadStateForm("addStateModalBody", "addStateStateValue");
    });

    $("#updatePatientStateState").change(function() {
        clearStateForm("editStateModalBody", 5)
        handleHospitalizedStateForm("editStateModalBody", "updatePatientStateState", false);
        handleIsHomeStateForm("editStateModalBody", "updatePatientStateState");
        handleInfectedStateForm("editStateModalBody", "updatePatientStateState");
        handleDeadStateForm("editStateModalBody", "updatePatientStateState");
    });

    $("#addPatientStateModal").on("hidden.bs.modal", function () {
        $('#addStateStateValue').val($("#addStateStateValue option:first").val());
        $('#addStateStateValue').trigger('change');
        clearStateForm("addStateModalBody", 4)
    });

    $("#addPatientStateModal").on("shown.bs.modal", function () {
        $('#addStateDate').val(new Date().toISOString().slice(0, 10));
    });
    
    $.ajax({
        url: "/get_states",
        type: "post",
        contentType: "application/json",
        data: JSON.stringify({"patient_id": '{{ patient.id }}' }),
        success: function (response) {
            renderStateHistoryTable(response);
        },
        error: function(jqXHR, textStatus, errorThrown) {
           console.log(textStatus, errorThrown, jqXHR);
           text = 'Неизвестная ошибка';
           if (jqXHR.status == 405)
               text = 'Пациент не найден';

           $.notify({
                icon: 'fa fa-times',
                message: text
            },{
                type: 'danger',
            });
        }
    })

</script>
{% with change=change, error_msg=error_msg %}
{% include "site_template/change_notification.html" %}
{% endwith %}
{% endblock javascripts %}
